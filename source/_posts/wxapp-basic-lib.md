---
title: 关于小程序的基础库
date: 2018-09-23 15:02:58
categories: 小程序双皮奶
tags: 教程
---
小程序的基础库，它包含了哪些东西，以及载入、更新的机制又是怎样的呢。
<!--more-->

## 小程序与基础库

### 基础库的组成 
关于基础库的成分，不得不提到我们之前说过的小程序渲染机制，参考 React 的 Virtual DOM。

![image](https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/13333.png)

**基础库除了处理 VD 的渲染问题，它还包括内置组件和逻辑层API，总的来说负责处理数据绑定、组件系统、事件系统、通信系统等一系列框架逻辑。**

小程序的基础库是 JavaScript 编写的，它可以被注入到渲染层和逻辑层运行。在渲染层可以用各类组件组建界面的元素，在逻辑层可以用各类 API 来处理各种逻辑。

同时，小程序的一些补充能力：自定义组件和插件，也有相应的基础代码，当然也需要添加到基础库里。

所以我们可以看到，小程序的基础库主要是：
1. 提供VD 渲染机制相关基础代码。
2. 提供封装后的内置组件。
3. 提供逻辑层的 API。
4. 提供其他补充能力（自定义组件和插件等）的基础代码。

### 基础库的载入
在开发网页时，经常会引用很多开源的 JS 库，在使用到这些库所提供的 API 前，我们需要先在业务代码前边引入这些库。

同样道理，我们需要在启动 APP 之前载入基础库，接着再载入业务代码。由于小程序的渲染层和逻辑层是两个线程管理，而我们一般说起基础库，也通常包括 WebView 基础库（渲染层），和 AppService 基础库（逻辑层）。

显然，所有小程序在微信客户端打开的时候，都需要注入相同的基础库。所以，小程序的基础库不会被打包在某个小程序的代码包里边，它会被提前内置在微信客户端。

将基础库内置在微信客户端，有两个好处：
1. 降低业务小程序的代码包大小。
2. 可以单独修复基础库中的Bug，无需修改到业务小程序的代码包。

### 小程序的启动
在小程序启动前，微信会提前准备好一个页面层级用于展示小程序的首页。这里就包括了逻辑层和渲染层分别的初始化以及公共库的注入。

![image](https://github-imglib-1255459943.cos.ap-chengdu.myqcloud.com/1537455257%281%29.jpg)

在小程序打开的时候，便开始进行基础 UI 的创建和代码包的下载，业务代码注入后，小程序便正式启动了。

### 基础库的更新
小程序的很多能力需要微信客户端来支撑，例如蓝牙、直播能力、微信运动等，可以说，小程序基础库的迭代离不开微信客户端的发布。

为了避免新版本的基础库给线上小程序带来未知的影响，微信客户端都是携带上一个稳定版的基础库发布的。等到微信客户端正式发布后，小程序会开始灰度推送新版本的基础库到微信客户端里，在这个过程需要仔细监控各类异常现象以及开发者和用户的反馈，一般灰度时长为12小时，灰度结束后，用户设备上就会有新版本的基础库。如果存在重大Bug，那此次推送会被回退。


### 参考
- [《小程序开发指南——小程序基础库的更新迭代》](https://developers.weixin.qq.com/ebook?action=get_post_info&token=935589521&volumn=1&lang=zh_CN&book=miniprogram&docid=000c8e5f95c1c88b00865be425b00a)


## 结束语
---
本节大致结合了小程序的启动来讲了下小程序的基础库。其实很多都能在小程序开发指南里找到，只是文字太多又有些乱，看一遍未必能记住，但是第二遍又找不到了。
哈哈哈吐槽下小程序的文档，很详细就是有点容易找不到。